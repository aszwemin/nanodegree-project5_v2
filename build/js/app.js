function DetailElement(e){this.placeId=e.placeId,this.name=e.name,this.icon=e.icon,this.type=e.type,this.location=e.location,this.openingHours=ko.observable(e.openingHours),this.open=ko.observable(e.openingHours?e.openingHours.open_now:null),this.phone=ko.observable("N/A"),this.address=ko.observable("N/A"),this.url=ko.observable("N/A"),this.chevronClass=ko.observable("glyphicon-chevron-down"),this.visible=ko.observable(!1),this.marker=e.marker,this.setDetails=function(e){this.address(e.address||"N/A"),this.phone(e.phone||"N/A"),this.url(e.url||"N/A"),this.reviews=e.reviews,this.openingHours(e.openingHours),this.open=ko.observable(e.openingHours?e.openingHours.open_now:null)}}function ViewModel(){function e(e){return new google.maps.LatLng(e.lat,e.lng)}function s(){function e(e,t){var n=null,c=null;t===google.maps.places.PlacesServiceStatus.OK?(l.searchResultsDetails([]),l._initialSearchResults=[],i(null),e.forEach(function(e){c=a(e),c&&(n=new DetailElement({placeId:e.place_id,name:e.name,icon:e.icon,type:e.types[0],location:e.geometry.location,openingHours:e.opening_hours,marker:c}),l.searchResultsDetails.push(n),l._initialSearchResults.push(n),o.getDetails({placeId:e.place_id},s.bind(n)))})):r("Getting Places was not successful for the following reason: "+t)}function s(e,t){var n,a=function(e){return{address:e.formatted_address,phone:e.international_phone_number,url:e.website,reviews:e.reviews,openingHours:e.opening_hours}},i=this;t===google.maps.places.PlacesServiceStatus.OK?(n=a(e),i.setDetails(n)):setTimeout(function(){o.getDetails({placeId:i.placeId},s.bind(i))},1e3)}var t={location:l.mapCenter(),radius:l.radius(),types:l.placeTypes()},o=new google.maps.places.PlacesService(l.map);l.markers([]),l.searchString(""),o.nearbySearch(t,e)}function t(e){l.geocoder.geocode({address:e},function(t,o){if(o===google.maps.GeocoderStatus.OK){var n=t[0].geometry.location;$.ajax({url:"http://api.openweathermap.org/data/2.5/weather?lat="+n.lat()+"&lon="+n.lng()+"&units=metric"}).done(function(e){l.weather({temperature:Math.round(e.main.temp),icon:e.weather[0].icon})}).fail(function(e){l.weather(null),r("Open weather API call failed for the following reason: "+e.statusText)}),l.map.setCenter(n),l.currentLocation(e),l.mapCenter(n),s()}else r("Geocode was not successful for the following reason: "+o)})}function o(e){function s(){var s=null;for(var t in l.searchResultsDetails())if(s=l.searchResultsDetails()[t],e.placeId===s.placeId)break;return null!==s?"<h4>"+s.name+'</h4><div class="no-gutter"><span class="glyphicon glyphicon-earphone" style="padding-right: 10px;" aria-hidden="true"></span><span>'+s.phone()+'</span></div><div class="no-gutter"><span class="glyphicon glyphicon-home" style="padding-right: 10px;" aria-hidden="true"></span><span>'+s.address()+"</span></div>":null}var t=e.getPosition(),o=s();null!==o&&(l._infowindow.setContent(o),l._infowindow.setPosition(t),l._infowindow.open(l.map,e),google.maps.event.addListener(l._infowindow,"closeclick",function(){}))}function n(e){e&&(e.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){e.setAnimation(null)},1400),o(e))}function a(e){if(-1!==l.placeTypes().indexOf(e.types[0])){var s=e.geometry.location,t={url:e.icon,size:new google.maps.Size(25,25),origin:new google.maps.Point(0,0),scaledSize:new google.maps.Size(25,25)},o=new google.maps.Marker({map:l.map,position:s,title:e.name,icon:t,type:e.types[0],placeId:e.place_id});return google.maps.event.addListener(o,"click",function(){n(o)}),l.markers.push(o),o}}function i(e){l.markers().forEach(function(s){s.setMap(e)})}function r(e){l.error(e),$("#errorModal").modal("show")}var l=this;return"undefined"==typeof google?void alert("Can't connect to google maps, please check your firewall settings"):(this.possiblePlaceTypes=["art_gallery","book_store","bowling_alley","casino","bank","hospital","museum","place_of_worship","bar","cafe","taxi_stand","train_station"],this.defaultPlaceTypes=["cafe","museum","bowling_alley","casino"],this.geocoder=new google.maps.Geocoder,this.mapCenter=ko.observable(e({lat:-34.397,lng:150.644})),this.currentLocation=ko.observable("London"),this.radius=ko.observable(200),this.zoom=ko.observable(16),this.placeTypes=ko.observableArray(this.defaultPlaceTypes),this.markers=ko.observableArray([]),this._infowindow=new google.maps.InfoWindow,this.searchString=ko.observable(""),this.searchResults=ko.observableArray([]),this.searchResultsVisible=ko.computed(function(){return this.searchResults()&&this.searchString()&&!this._searchSelected},this),this._initialSearchResults=[],this._searchTexts=[],this._searchSelected=!1,this.searchResultsDetails=ko.observableArray([]),this.placeDetails=ko.observable(),this.weather=ko.observable(null),this.error=ko.observable(""),this.initMap=function(e){var s={center:l.mapCenter(),zoom:l.zoom()};l.map=new google.maps.Map(e,s)},this.saveSettings=function(e){if(0===l.placeTypes().length)return void r("Please select at least one type");var s=$("#formLocation",e).val();t(s),$("#settingsModal").modal("hide")},this.selectSearchResult=function(e){l._searchSelected=!0,l.searchString(e.text),"place"===e.type?l.searchResultsDetails(ko.utils.arrayFilter(l._initialSearchResults,function(s){return s.name===e.text})):"type"===e.type&&l.searchResultsDetails(ko.utils.arrayFilter(l._initialSearchResults,function(s){return s.type===e.text}))},this.toggleDetailVisible=function(e){"glyphicon-chevron-up"===e.chevronClass()?(e.chevronClass("glyphicon-chevron-down"),e.visible(!1)):(e.chevronClass("glyphicon-chevron-up"),e.visible(!0)),n(e.marker)},this.setPlaceDetails=function(e){l.placeDetails({openingHours:e.openingHours,reviews:e.reviews})},this.formatType=function(e){return e.replace(/_/g," ")},this.searchString.subscribe(function(){var e,s,t;l.searchResults([]),l._searchTexts=[];for(var o in l.markers())e=l.markers()[o],s=e.type.toLowerCase(),t=e.title.toLowerCase(),l.searchString().length?t.indexOf(l.searchString().toLowerCase())>-1?(e.setMap(l.map),l.searchResults.push({icon:"pac-icon-marker",text:e.title,type:"place"}),l._searchTexts.push(e.title)):s.indexOf(l.searchString().toLowerCase())>-1?(e.setMap(l.map),-1==l._searchTexts.indexOf(e.type)&&(l.searchResults.push({icon:"pac-icon-search",text:e.type,type:"type"}),l._searchTexts.push(e.type))):e.setMap(null):e.setMap(l.map);l._searchSelected&&(l._searchSelected=!1)}),this.initMap(document.getElementById("map-canvas")),void t("London"))}$(function(){ko.applyBindings(new ViewModel)});